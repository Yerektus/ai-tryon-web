name: Dresscode Landing Smoke Check

on:
  push:
    paths:
      - "src/**"
      - "public/**"
      - "package.json"
      - "package-lock.json"
      - "next.config.mjs"
      - "tailwind.config.ts"
      - "tsconfig.json"
      - ".github/workflows/frontend-ci.yml"
  pull_request:
    paths:
      - "src/**"
      - "public/**"
      - "package.json"
      - "package-lock.json"
      - "next.config.mjs"
      - "tailwind.config.ts"
      - "tsconfig.json"
      - ".github/workflows/frontend-ci.yml"
  workflow_dispatch:

jobs:
  smoke-check:
    runs-on: ubuntu-latest
    env:
      NEXT_TELEMETRY_DISABLED: "1"
      NEXT_PORT: "3000"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ vars.NODE_VERSION || '20' }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build app
        run: npm run build

      - name: Start app and check /
        run: |
          npm run start -- --hostname 127.0.0.1 --port "${NEXT_PORT}" > next-server.log 2>&1 &
          APP_PID=$!

          cleanup() {
            kill "$APP_PID" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          for i in {1..60}; do
            if curl -fsS "http://127.0.0.1:${NEXT_PORT}/" >/dev/null; then
              echo "Smoke check passed."
              exit 0
            fi
            sleep 2
          done

          echo "Smoke check failed. Last logs:"
          tail -n 200 next-server.log || true
          exit 1

      - name: Upload app logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dresscode-landing-log
          path: next-server.log
          if-no-files-found: ignore
